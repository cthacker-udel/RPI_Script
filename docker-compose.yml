services:
    app:
        build: .
        depends_on:
            - db
        environment:
            PI_NAME: dev_pi
            DB_IDS: ids
            DB_TEMPERATURES: temperatures
            DB_USERNAME: root
            DB_PASSWORD: root
            DB_HOST: db
            DB_SCHEMA: rpi_db
        command: python main.py
        restart: no
    db:
        image: mysql:latest
        environment:
            MYSQL_ROOT_PASSWORD: root
            MYSQL_DATABASE: rpi_db
        restart: always
        ports:
            - "3306:3306"
        healthcheck:
            test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
            interval: 5s
            timeout: 5s
            retries: 10
            start_period: 30s
    db-init:
        image: mysql:latest
        depends_on:
            db:
                condition: service_healthy
        volumes:
            - ./database_schema.sql:/schema.sql
        entrypoint:
            ["bash", "-c", "mysql -h db -u root -proot rpi_db < /schema.sql"]
